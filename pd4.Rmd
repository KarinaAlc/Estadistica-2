---
title: "Sesi√≥n Multinomial"
output:
  html_document:
    toc: yes
    toc_float: yes
    collapsed: no
    number_sections: no
    toc_depth: 2
    theme: simplex
    highlight: kate
    always_allow_html: yes
    code_folding: show
  fontfamily: "Apple Color Emoji"
  pdf_document:
    latex_engine: lualatex
    toc: true
editor_options: 
  markdown: 
    wrap: 72
---

<br>

<center><img src=" " width="200"/></center>

```{r,echo=FALSE, out.width="30%",fig.align="left"}
knitr::include_graphics("logoPUCP.png") 
```

## **FACULTAD DE CIENCIAS SOCIALES - PUCP** <br>

### Curso: POL 304 - Estad√≠stica para el an√°lisis pol√≠tico 2 \| Semestre 2024 - 1

<br>

#### Jefas de Pr√°ctica: Karina Alc√°ntara üë©‚Äçüè´ y Lizette Crisp√≠n üë©‚Äçüè´<br>

<br> <br>

```{r,echo=FALSE, out.width="100%",fig.align="center"}
knitr::include_graphics("PD4_GLM.png") 
```

<br>

```{r,echo=FALSE, out.width="100%",fig.align="center"}
knitr::include_graphics("PD4_ECUACI√ìN.png") 
```

<br>

```{r,echo=FALSE, out.width="100%",fig.align="center"}
knitr::include_graphics("PD4_Ejemplo.png") 
```

Pregunta de investigaci√≥n:

```{=html}
<style>
.custom-text {
  color: #00688B;
  font-family: Helvetica, sans-serif;
  text-align: center;
  font-weight: bold;
  font-size: 22px;
}
</style>
```
::: custom-text
¬øUna econom√≠a liberal influye en el nivel de democracia? ü§î
:::

## Base de Datos

La base de datos a trabajar combina los datos obtenidos en el Democracy
Index[^1] y el Index of Economic Freedom[^2] . Lo que veremos en esta
clase es la relaci√≥n entre el tipo de r√©gimen pol√≠tico *(democracia,
democracia fallida y dictadura)* con variables econ√≥micas.

[^1]: <https://en.wikipedia.org/wiki/Democracy_Index>

[^2]: <https://en.wikipedia.org/wiki/Index_of_Economic_Freedom>

Llamamos a las librer√≠as

```{r,warning=FALSE,message=FALSE, results = 'hide'}
library(rio)
library(nnet)
library(DescTools)
library(RVAideMemoire)
library(marginaleffects)
library(dplyr)
```

Exploremos la data:

```{r,warning=FALSE,message=FALSE, results = 'hide'}
demofree <- import("https://github.com/schrodingercase/primary/raw/master/demofree.xlsx")
str(demofree) #Ver estructura de la base de datos
```

# Formateo de las variables

### 1.1 Limpieza de data e identificaci√≥n de las variables

```{r}
demofree <- demofree %>% 
  rename(regimen = `Regime type`,
         property = `Property Rights`,
         tradefree = `Trade Freedom`,
         busfree =`Business Freedom`)
```

Eliminamos casos perdidos

```{r}
demofree <- demofree[complete.cases(demofree$regimen),]
```

Comencemos con la variable dependiente:

```{r}
demofree %>% 
  group_by(regimen) %>% 
  summarise (Frecuencia= n())
```

Ojo con Hybrid regime y Flawed democracy

```{r}
demofree <- demofree %>% 
  mutate(regimen = case_when(regimen == "Full democracy" ~ 3,
                             regimen == "Authoritarian" ~  1,
                             T ~ 2))
```

Confirmamos la suma

```{r}
demofree %>% 
  group_by(regimen) %>% 
  summarise (FrecuenciaRecod= n())
```

Formateamos la variable regimen:)

```{r}
demofree <- demofree %>%
            mutate(regimen = factor(regimen, 
                                    levels = c("1", "2", "3"),
                                    labels = c("Dictadura", "Democracia fallida", "Democracia")))

```


### 1.2. Elegir la l√≠nea base

La l√≠nea de base o baseline sirve para tener una referencia al
interpretar los resultados del modelo. En este caso nuestra dependiente
fue recodificada en "Democracia","Democracia fallida","Dictadura".
Entonces, "Democracia fallida" al estar en el medio es nuestra baseline.

Verificamos qu√© ha considerado R

```{r}
contrasts(demofree$regimen)
```

Con el siguiente comando establecemos la categor√≠a de referencia. en
*ref* mencionamos c√≥mo se llama esta categor√≠a, por eso es importante
tener bien etiquetadas las variables.

```{r}
demofree$regimen <- relevel(demofree$regimen , ref = "Democracia fallida")
```

# Modelo 1

-   Variable dependiente= Regimen Pol√≠tico `regimen`

-   Variable independiente= Trade Freedom `tradefree` (Libertad de
    comercio) y Property Rights `property` (Derecho a la propiedad
    privada)

## Paso 1: Preparar la data

confirmamos que nuestras variables est√©n en el formato adecuado
(num√©rico)

```{r}
str(demofree$tradefree)
str(demofree$property)
```

```{r}
demofree$property <- as.numeric(demofree$property)
demofree$tradefree <- as.numeric(demofree$tradefree)
```

## Paso 2: Modelo log√≠stico

### 2.1 Realizar modelo log√≠stico

No olvidemos cual es nuesta l√≠nea de base para la interpretaci√≥n.

```{r}
mod1 <- multinom(regimen ~ property + tradefree, data = demofree)  #del paquete nnet
summary(mod1)
```

### 2.2: Relaci√≥n de las variables

Un primer paso ser√≠a ver el signo de los coeficientes para determinar la
relaci√≥n entre la variable independiente y la variable dependiente

**Derechos de propiedad**

-   Coeficiente (dictadura) :-0.02654594

Si un pa√≠s aumenta en un punto el indicador de derechos a la propiedad,
la probabilidad de que sea dictadura a que sea democracia fallidad
disminuye

-   Coeficiente (democracia): 0.15297576

Si un pa√≠s aumenta en un punto el indicador de derechos a la propiedad,
la probabilidad de que sea democracia a que sea democracia fallida
aumenta

**Libertad econ√≥mica**

-   Coeficiente(dictadura) :-0.07105396

Si un pa√≠s aumenta en un punto indicador de libre comercio, la
probabilidad de que sea dictadura a que sea democracia fallida
disminuye.

-   Coeficiente(democracia):0.01435271

Si un pa√≠s aumenta en un punto el indicador de libre comercio, la
probabilidad de que sea democracia a que sea democracia fallida aumenta

### 2.3: Aplicando la ecuaci√≥n

#### Recordamos la ecuaci√≥n y realizamos un ejemplo

```{r,echo=FALSE, out.width="80%",fig.align="center"}
knitr::include_graphics("ecuacion.jpeg") 
```

Usamos los valores de 50 (property) y 60 (tradefree)

**prob dictadura**

```{r}
numeDct<-exp(6.015109-0.02654594*50-0.07105396*60)
denomDct<-1+numeDct
ProbDct<-numeDct/denomDct
ProbDct
```

**prob democracia**

```{r}
numDemo= exp(-13.772977)*(exp(0.15297576*50)*exp(0.01435271*60))
denomDemo=1+numDemo
ProbDemo=numDemo/denomDemo
ProbDemo
```

¬øProbabilidad de la democracia fallida?

```{r,echo=FALSE, out.width="80%",fig.align="center"}
knitr::include_graphics("prob-demofallida.jpeg") 
```

### 2.4: SIGNIFICANCIA DE LAS VARIABLES

```{r}
#install.packages("RVAideMemoire")
library(RVAideMemoire)
```

### 2.3: Significancia de las variables

Se debe realizar variable por variable

```{r}
test.multinom(mod1,property) # Se coloca test.multinom(nombredelmodelo,variableindependiente1)
```

Para la variable property, de la dos comparaciones con nuestra categor√≠a
de referencia, la √∫nica significativa es cuando se compara democracia
con democracia fallida.

```{r}
test.multinom(mod1,tradefree)
# Se coloca test.multinom(nombredelmodelo,variableindependiente2)
```

Para la variable tradefree, de la dos comparaciones con nuestra
categor√≠a de referencia, la √∫nica significativa es cuando se compara
dictadura con democracia fallida.

## Paso 3: Interpretaci√≥n de coeficientes con efectos marginales

Con los efectos marginales podemos medir la probabilidad de que ocurra
cada escenario (democracia, democracia fallida o dictadura). Para la
interpretaci√≥n usamos el estimado.

```{r}
avg_slopes(mod1)[,c(1,2,3)]  #del paquete marginaleffects
```

-   Cuando en un pa√≠s el √≠ndice de derecho a la propiedad incrementa un
    punto, la probabilidad de que este pa√≠s presente una democracia
    aumenta en promedio 0.00958.

-   Cuando en un pa√≠s el √≠ndice de libertad de comercio incrementa un
    punto, la probabilidad de que este pa√≠s presente una democracia
    aumenta en promedio 0.00141.

-   Cuando en un pa√≠s el √≠ndice de derecho a la propiedad incrementa un
    punto, la probabilidad de que este pa√≠s presente una democracia
    fallida disminuye en promedio 0.00423.

-   Cuando en un pa√≠s el √≠ndice de derecho a la propiedad incrementa un
    punto, la probabilidad de que este pa√≠s presente una democracia
    fallida aumenta en promedio 0.00998

## Paso 4: Recordando la ecuaci√≥n

Usemos los siguientes valores:

-   Property = 80

-   Tradefree= 50

Probabilidad de que sea **dictadura**

```{r}
Num1<-exp(6.015109-0.02654594*80-0.07105396*50)
Deno1<-1+Num1
ProbDictadura<-Num1/Deno1
ProbDictadura
```

Si un pa√≠s tiene 80 de indice de derecho a la propiedad y 50 de indice
de libertad de comercio, tiene un 0.58 de probabilidad de ser una
dictadura.

Probabilidad de que sea **democracia**

```{r}
Num2 <- exp(-13.772977+0.15297576*80+0.01435271*50)
Deno2<-1+Num2
ProbDemo<-Num2/Deno2
ProbDemo
```

Si un pa√≠s tiene 80 de indice de derecho a la propiedad y 50 de indice
de libertad de comercio, tiene un 0.30 de probabilidad de ser una
democracia

¬øCu√°l es la probabilidad de que sea una **democracia fallida**?

```{r}
1-ProbDictadura-ProbDemo
```

Si un pa√≠s tiene 80 de indice de derecho a la propiedad y 50 de indice
de libertad de comercio, tiene un 0.11 de probabilidad de ser una
democracia fallida

# Modelo 2

¬øQu√© sucede si a√±adimos a nuestras variables independientes una
categ√≥rica?

```{r,echo=FALSE, out.width="20%",fig.align="center"}
knitr::include_graphics("tehc.png") 
```

La libertad comercial (Business Freedom) es muchas veces reconocida como
una variable indispensable en toda democracia. \*\*¬øCu√°nto afectar√≠a al
modelo?\*\* Vamos a crear un modelo agregando esta variable

## Paso 1: Preparaci√≥n de variable

Para fines pr√°cticos, dividamos la variable en pa√≠ses con *poca libertad
comercial* y con *mucha libertad comercial*.

```{r}
demofree$busfree <- as.numeric(demofree$busfree)
demofree$busfree <- ifelse(demofree$busfree<=74.50, "Poca", "Mucha")
```

Corroboramos

```{r}
demofree %>% 
  group_by(busfree) %>% 
  summarise (FrecLibCom= n())
```

#### Volvemos "Dummy" la variable busfree

Utilizamos la libreria fastDummies para dicotomizar las variables, en
select_columns indicamos qu√© variable queremos

```{r,message=FALSE,warning=FALSE}
library(fastDummies)
demofree <- dummy_cols(demofree, select_columns = c("busfree"))
```

Revisamos los resultados

```{r}
demofree %>% 
  group_by(busfree_Mucha) %>% 
  summarise (N= n())
```

```{r}
demofree %>% 
  group_by(busfree_Poca) %>% 
  summarise (N= n())
```

## Paso 2: Modelo log√≠stico

```{r}
mod2<- multinom(regimen ~ property + tradefree + busfree_Poca, data = demofree)
summary(mod2)
```

### 2.2. Relaci√≥n de las variables

#### **Derechos de propiedad**

-   Coeficiente (dictadura) :-0.03774142

Si un pa√≠s aumenta en un punto el indicador de derechos a la propiedad,
la probabilidad de que sea dictadura a que sea democracia fallidad
disminuye

-   Coeficiente (democracia): 0.14741855

Si un pa√≠s aumenta en un punto el indicador de derechos a la propiedad,
la probabilidad de que sea democracia a que sea democracia fallida
aumenta

#### **Libertad econ√≥mica**

-   Coeficiente(dictadura) :-0.07454554

Si un pa√≠s aumenta en un punto indicador de libre comercio, la
probabilidad de que sea dictadura a que sea democracia fallida disminuye

-   Coeficiente(democracia):0.01448272

Si un pa√≠s aumenta en un punto el indicador de libre comercio, la
probabilidad de que sea democracia a que sea democracia fallida aumenta

#### **Poca libertad de comercio**

-   Coeficiente(dictadura): -1.0531380

Cuando un pa√≠s s√≠ tiene poca libertad de comercio (es 1), la
probabilidad de que sea dictadura a que sea democracia fallida
disminuye.

-   Coeficiente(democracia): -0.2906452

Cuando un pa√≠s s√≠ tiene poca libertad de comercio (es 1), la
probabilidad de que sea democracia a que sea democracia fallida
disminuye.

### 2.1: Significancia de las variables

```{r}
test.multinom(mod2,property) # Se coloca test.multinom(nombredelmodelo,variableindependiente1)
```

```{r}
test.multinom(mod2,tradefree)
# Se coloca test.multinom(nombredelmodelo,variableindependiente2)
```

## Paso 3: Interpretaci√≥n de coeficientes con efectos marginales

```{r}
avg_slopes(mod2)[,c(1,2,4)]
```

## Paso 4: Recordamos la ecuaci√≥n

Usemos los siguientes valores:

-   Property = 50

-   Tradefree= 60

-   Busfreef= 1

Probabilidad de que sea dictadura

```{r}
Num1<-exp(7.719501-0.037741424*50-0.07454554*60-1.0531380*1)
Deno1<-1+Num1
ProbDictadura<-Num1/Deno1
ProbDictadura
```

Probabilidad de que sea *democracia*

```{r}
Num2<- exp(-13.207954+0.14741855*50+0.01448272*60-0.2906452*1)
Deno2<-1+Num2
ProbDemo<-Num2/Deno2
ProbDemo
```

Probabilidad de que sea *democracia fallida*

```{r}
1-ProbDictadura-ProbDemo
```

# Comparar modelos

### AIC

Debemos elegir el que arroje un menor valor. Ojo! Solo se usa para
comparar modelos.

```{r}
AIC(mod1) #GANADOR
AIC(mod2)
```

¬øPredice bien mi modelo? Revisemos qu√© tan bien estar√≠an categorizados
mis pa√≠ses seg√∫n mi modelo 1.

```{r}
table(demofree$regimen)
table(demofree$regimen,predict(mod1))
```

Vemos que ha categorizado a la mayor√≠a de pa√≠ses bien por cada
categor√≠as.

Esto tambi√©n podemos verlo en porcentaje

```{r}
prop.table(table(demofree$regimen,predict(mod1)),1)
```

### PSEUDO R CUADRADO

```{r,warning=FALSE}
PseudoR2(mod1, which = c("Nagelkerke")) #del paquete DescTools
PseudoR2(mod2, which = c("Nagelkerke"))
```

Seg√∫n el Pseudo R2, los modelos tienen un nivel de ajuste muy parecido.

<br> <br>

Cat facts

```{r}
library("cowsay", quietly = TRUE, warn.conflicts = FALSE)
say("catfact", "cat")
```
